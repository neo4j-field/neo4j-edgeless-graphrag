services:
  # Note: Docker Compose automatically reads .env from the project directory
  # for ${VAR} interpolation. Do NOT use env_file here â€” the Neo4j image
  # interprets all NEO4J_* variables as configuration, which would conflict
  # with client-side variables like NEO4J_URI or NEO4J_ADMIN_PASSWORD.

  neo4j:
    image: neo4j:enterprise
    container_name: neo4j-graphrag
    hostname: neo4j
    environment:
      # License acceptance for 30 day trial license
      - NEO4J_ACCEPT_LICENSE_AGREEMENT=yes
      
      # Authentication (password from .env)
      - NEO4J_AUTH=neo4j/${NEO4J_ADMIN_PASSWORD}
      
      # Plugins - Neo4j will download these automatically
      - NEO4J_PLUGINS=["apoc"]
      
      # Security settings
      - NEO4J_dbms_security_auth__enabled=true
      - NEO4J_dbms_security_auth__minimum__password__length=12
      
      # SSL/TLS Configuration for Bolt
      - NEO4J_server_bolt_tls__level=REQUIRED
      - NEO4J_dbms_ssl_policy_bolt_enabled=true
      - NEO4J_dbms_ssl_policy_bolt_base__directory=/ssl/bolt
      - NEO4J_dbms_ssl_policy_bolt_private__key=private.key
      - NEO4J_dbms_ssl_policy_bolt_public__certificate=public.crt
      - NEO4J_dbms_ssl_policy_bolt_client__auth=NONE
      
      # SSL/TLS Configuration for HTTPS
      - NEO4J_server_https_enabled=true
      - NEO4J_dbms_ssl_policy_https_enabled=true
      - NEO4J_dbms_ssl_policy_https_base__directory=/ssl/https
      - NEO4J_dbms_ssl_policy_https_private__key=private.key
      - NEO4J_dbms_ssl_policy_https_public__certificate=public.crt
      - NEO4J_dbms_ssl_policy_https_client__auth=NONE
      
      # Disable HTTP
      - NEO4J_server_http_enabled=false
      
      # Plugin Configuration
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*
      
      # Browser Security
      - NEO4J_browser_retain__connection__credentials=false
      - NEO4J_browser_credential__timeout=15m
      - NEO4J_browser_allow__outgoing__connections=false
      - NEO4J_client_allow__telemetry=false
      
      # Logging
      - NEO4J_dbms_logs_query_enabled=INFO
      - NEO4J_db_logs_query_obfuscate__literals=true
      - NEO4J_db_logs_query_parameter__logging__enabled=false
      
      # Usage reporting
      - NEO4J_dbms_usage__report_enabled=false
      
      # Memory settings
      - NEO4J_server_memory_heap_initial__size=1G
      - NEO4J_server_memory_heap_max__size=2G
      - NEO4J_server_memory_pagecache_size=1G
      
      # Network ports (changed from defaults for security)
      - NEO4J_server_bolt_listen__address=0.0.0.0:7687
      - NEO4J_server_https_listen__address=0.0.0.0:7473
      
    ports:
      - "7688:7687"  # Bolt (TLS)
      - "7473:7473"  # HTTPS
    
    volumes:
      # Data persistence
      - ./neo4j/data:/data
      - ./neo4j/logs:/logs
      - ./neo4j/import:/import
      - ./neo4j/conf:/conf
      - ./neo4j/metrics:/metrics
      
      # SSL certificates
      - ./neo4j/certificates:/ssl:ro
    
    networks:
      - graphrag-network
    
    healthcheck:
      test: [ "CMD-SHELL", "neo4j-admin database info" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  privatemode-proxy:
    image: ghcr.io/edgelesssys/privatemode/privatemode-proxy:latest
    container_name: privatemode-proxy
    hostname: privatemode-proxy
    environment:
      - API_KEY=${PRIVATEMODE_API_KEY}
      - PRIVATEMODE_CA_CERT=/certs/localhost-cert.pem
    command:
      - --apiKey=${PRIVATEMODE_API_KEY}
      - --tlsCertPath=/certs/localhost-cert.pem
      - --tlsKeyPath=/certs/localhost-key.pem
    ports:
      - "8089:8080"
    volumes:
      - ./privatemode/certs:/certs:ro
    networks:
      - graphrag-network
    depends_on:
      neo4j:
        condition: service_healthy

  # -- Official Neo4j MCP Server (HTTP + TLS) --
  neo4j-mcp:
    image: mcp/neo4j:latest
    container_name: neo4j-mcp
    hostname: neo4j-mcp
    ports:
      - "443:443"
    environment:
      # -- Transport mode --
      - NEO4J_TRANSPORT_MODE=http
      - NEO4J_MCP_HTTP_HOST=0.0.0.0
      - NEO4J_MCP_HTTP_PORT=443

      # -- TLS / HTTPS --
      - NEO4J_MCP_HTTP_TLS_ENABLED=true
      - NEO4J_MCP_HTTP_TLS_CERT_FILE=/certs/server.crt
      - NEO4J_MCP_HTTP_TLS_KEY_FILE=/certs/server.key

      # -- Neo4j connection --
      - NEO4J_URI=bolt+ssc://neo4j:7687
      - NEO4J_DATABASE=neo4j

      # -- Optional: disable telemetry --
      - NEO4J_TELEMETRY=false
      - NEO4J_LOG_LEVEL=info

    volumes:
      - ./mcp/certs:/certs:ro
    networks:
      - graphrag-network
    depends_on:
      neo4j:
        condition: service_healthy

networks:
  graphrag-network:
    driver: bridge